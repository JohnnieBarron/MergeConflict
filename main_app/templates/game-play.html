 {% extends 'base.html' %}
  {% load static %}

  {% block content %}
  <div class="game-container">
      <div class="game-header">
          <h2>Room: {{ room.name }}</h2>
          <p>Round {{ current_round.round_number }} of {{ room.round_limit }}</p>
      </div>

      <!-- Black Card Section -->
      <div class="black-card-section">
          <h3>Black Card</h3>
          <div class="card black-card">
              {% if current_round and current_round.black_card %}
                  <p>{{ current_round.black_card.text|default:"Loading..." }}</p>
                  <small>Pick {{ current_round.black_card.pick|default:1 }}</small>
              {% else %}
                  <p>No black card available</p>
              {% endif %}
          </div>
      </div>

      <!-- Player Status -->
      <div class="player-info">
          <p>Your Score: {{ player.score }}</p>
          {% if is_judge %}
              <p class="judge-badge">üë®‚Äç‚öñÔ∏è You are the Card Czar!</p>
          {% endif %}
      </div>

      <!-- Game Phase Content -->
      {% if current_round.status == 'card_selection' %}
          {% if not is_judge %}
              {% if not has_submitted %}
                  <!-- Player's Hand -->
                  <div class="hand-section">
                      <h3>Your Cards</h3>
                      <p class="player-instruction">Click on the card you want to play!</p>
                      <form id="card-form" method="post" action="{% url 'submit_card' room.room_code %}">
                          {% csrf_token %}
                          <input type="hidden" id="card_id" name="card_id" value="">
                          <div class="card-grid">
                              {% for card in player.card_hand %}
                                  <div class="card white-card playable" onclick="submitCard('{{ card.id }}')">
                                      <p>{{ card.text }}</p>
                                  </div>
                              {% endfor %}
                          </div>
                      </form>
                  </div>
              {% else %}
                  <p class="waiting-message">Waiting for other players to submit...</p>
              {% endif %}
          {% else %}
              <p class="waiting-message">Waiting for players to submit their cards...</p>
          {% endif %}
      {% endif %}

      {% if current_round.status == 'judging' %}
          {% if is_judge %}
              <!-- Judge View -->
              <div class="judging-section">
                  <h3>Select the Winning Card</h3>
                  <p class="judge-instruction">Click on the card you think is the best!</p>
                  <!-- Debug info -->
                  <p style="font-size: 12px; color: #999;">Debug: {{ submissions|length }} submissions</p>
                  <form id="judge-form" method="post" action="{% url 'select_winner' room.room_code %}">
                      {% csrf_token %}
                      <input type="hidden" id="submission_id" name="submission_id" value="">
                      <div class="submissions-grid">
                          {% for submission in submissions %}
                              <div class="card white-card submission" onclick="selectWinner({{ submission.id }})">
                                  {% for card in submission.white_cards %}
                                      <p>{{ card.text }}</p>
                                  {% endfor %}
                              </div>
                          {% empty %}
                              <p>No submissions yet!</p>
                          {% endfor %}
                      </div>
                  </form>
              </div>
          {% else %}
              <p class="waiting-message">The Card Czar is choosing a winner...</p>
          {% endif %}
      {% endif %}

      <!-- Players List -->
      <div class="players-sidebar">
          <h3>Players</h3>
          <div class="players-list">
              {% for game_player in players %}
                  <div class="player-score-card">
                      <div class="player-name">
                          {{ game_player.user.username }}
                          {% if current_round.judge == game_player.user %}
                              <span class="judge-indicator">üë®‚Äç‚öñÔ∏è</span>
                          {% endif %}
                      </div>
                      <div class="player-score">{{ game_player.score }}</div>
                  </div>
              {% endfor %}
          </div>
      </div>
  </div>

  <style>
  .game-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
  }

  .card {
      border: 2px solid #333;
      border-radius: 8px;
      padding: 20px;
      margin: 10px;
      cursor: pointer;
      transition: transform 0.2s;
  }

  .black-card {
      background-color: #000;
      color: #fff;
      font-size: 1.2em;
  }

  .white-card {
      background-color: #fff;
      color: #000;
      position: relative;
  }

  .white-card:hover {
      transform: scale(1.05);
  }
  
  /* Submission cards for judging */
  .submission {
      cursor: pointer;
      transition: all 0.3s ease;
  }
  
  .submission:hover {
      background-color: #000;
      color: #fff;
      transform: scale(1.05);
  }
  
  .judge-instruction, .player-instruction {
      text-align: center;
      font-style: italic;
      color: #666;
      margin-bottom: 20px;
  }
  
  /* Playable cards for players */
  .playable {
      cursor: pointer;
      transition: all 0.3s ease;
  }
  
  .playable:hover {
      background-color: #000;
      color: #fff;
      transform: scale(1.05);
  }

  .white-card input[type="radio"] {
      position: absolute;
      opacity: 0;
  }

  .white-card input[type="radio"]:checked + p {
      font-weight: bold;
  }

  .card-grid, .submissions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
  }

  .players-sidebar {
      position: fixed;
      right: 20px;
      top: 100px;
      background: white;
      border: 3px solid black;
      border-radius: 12px;
      padding: 20px;
      min-width: 200px;
  }
  
  .players-sidebar h3 {
      margin-bottom: 15px;
      text-align: center;
  }
  
  .players-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
  }
  
  .player-score-card {
      background-color: #f9f9f9;
      border: 2px solid #333;
      border-radius: 8px;
      padding: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: transform 0.2s;
  }
  
  .player-score-card:hover {
      transform: scale(1.05);
  }
  
  .player-name {
      font-weight: bold;
      color: #333;
  }
  
  .player-score {
      font-size: 24px;
      font-weight: bold;
      color: #000;
      background-color: #FFD700;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
  }

  .judge-badge {
      background: #4CAF50;
      color: #fff;
      padding: 5px 10px;
      border-radius: 5px;
      font-weight: bold;
  }

  .waiting-message {
      text-align: center;
      font-size: 1.2em;
      color: #666;
      margin: 40px 0;
  }
  </style>

  <script>
  // Store current round status
  let currentRoundStatus = "{{ current_round.status }}";
  let currentRoundNumber = {{ current_round.round_number|default:0 }};
  let isJudge = {{ is_judge|lower }};
  
  // Only start polling if not judging or not the judge
  if (!(isJudge && currentRoundStatus === 'judging')) {
      // Poll for game status updates every 3 seconds
      const statusChecker = setInterval(function() {
          fetch("{% url 'game_status' room.room_code %}")
              .then(response => response.json())
              .then(data => {
                  console.log('Status check:', data);
                  // Only reload if something actually changed
                  if (data.round_status !== currentRoundStatus || 
                      data.round_number !== currentRoundNumber) {
                      console.log('Reloading: status or round changed');
                      location.reload();
                  }
              })
              .catch(error => {
                  console.error('Status check failed:', error);
              });
      }, 3000);
  } else {
      console.log('Judge in judging phase - auto-refresh disabled');
  }
  
  // Function to select winner (for judges)
  function selectWinner(submissionId) {
      console.log('Selecting winner with submission ID:', submissionId);
      
      // Get the form
      const form = document.getElementById('judge-form');
      const hiddenInput = document.getElementById('submission_id');
      
      if (!form) {
          console.error('Form not found!');
          return;
      }
      
      if (!hiddenInput) {
          console.error('Hidden input not found!');
          return;
      }
      
      // Set the hidden input value
      hiddenInput.value = submissionId;
      console.log('Set hidden input to:', hiddenInput.value);
      
      // Submit the form
      console.log('Submitting form...');
      form.submit();
  }
  
  // Function to submit card (for players)
  function submitCard(cardId) {
      console.log('Submitting card with ID:', cardId);
      
      // Get the form
      const form = document.getElementById('card-form');
      const hiddenInput = document.getElementById('card_id');
      
      if (!form) {
          console.error('Form not found!');
          return;
      }
      
      if (!hiddenInput) {
          console.error('Hidden input not found!');
          return;
      }
      
      // Set the hidden input value
      hiddenInput.value = cardId;
      console.log('Set hidden input to:', hiddenInput.value);
      
      // Submit the form
      console.log('Submitting form...');
      form.submit();
  }
  </script>
  {% endblock %}
